{% extends "base.html" %}

{# ================================================================== #}
{# BLOQUE 1: TÍTULO DE LA PÁGINA Y ESTILOS CSS ESPECÍFICOS           #}
{# ================================================================== #}
{% block title %}{{ page_title | default('Herramienta de Medición') }}{% endblock %}

{% block head %}
    {{ super() }} {# Esto hereda los estilos de base.html #}
    {# Aquí podrías enlazar un CSS externo si lo prefieres: #}
    {# <link rel="stylesheet" href="{{ url_for('static', filename='css/measure_tool.css') }}"> #}
    <style>
        /* Estilos específicos para esta página para mantener todo en un archivo */
        body {
            /* Forzamos a que el layout ocupe toda la pantalla */
            height: 100vh;
            overflow: hidden; /* Evitamos el scroll principal */
        }

        .top-controls-toolbar {
            flex-shrink: 0; /* Para que la barra no se encoja */
        }
        
        .pdf-tool-layout-container {
            display: flex;
            gap: 1rem;
            /* Altura calculada para ocupar el espacio restante */
            height: calc(100vh - 100px); /* Ajusta 100px según la altura de tu navbar + toolbar */
        }

        .pdf-viewer-area {
            flex-grow: 1;
            position: relative;
            overflow: auto; /* El scroll para el plano grande estará aquí */
            border: 1px solid #ddd;
            background-color: #e9ecef;
        }

        .canvas-wrapper {
            position: relative;
            /* El tamaño se lo dará el JS */
        }

        #pdf-canvas, #measure-canvas {
            position: absolute;
            top: 0;
            left: 0;
            display: block;
        }
        #pdf-canvas { z-index: 1; }
        #measure-canvas { z-index: 2; }

        .controls-sidebar-reduced {
            width: 280px;
            flex-shrink: 0;
            overflow-y: auto;
            height: 100%;
        }

        /* --- ESTILOS RESPONSIVOS PARA ESTA PÁGINA --- */
        @media (max-width: 992px) {
            body {
                height: auto;
                overflow: auto;
            }
            .pdf-tool-layout-container {
                flex-direction: column;
                height: auto;
            }
            .controls-sidebar-reduced {
                width: 100%;
                margin-top: 1rem;
                height: auto;
                max-height: 40vh; /* Límite para que no ocupe toda la pantalla */
            }
            .pdf-viewer-area {
                height: 70vh; /* Altura fija para el visor en móvil */
            }
        }
    </style>
{% endblock %}


{# ================================================================== #}
{# BLOQUE 2: CONTENIDO PRINCIPAL DE LA PÁGINA                       #}
{# ================================================================== #}
{% block content %}
<div class="top-controls-toolbar card mb-3">
    <div class="card-body p-2">
        <div class="row gx-2 gy-2 align-items-center">

            <div class="col-auto">
                <input type="file" class="form-control form-control-sm" id="pdf-file-input" accept=".pdf" title="Cargar PDF Local">
            </div>

            <div class="col-auto"><div class="vr mx-1"></div></div>

            <div class="col-auto">
                <div class="btn-group">
                    <button type="button" class="btn btn-info btn-sm" id="start-calibrate-btn" title="Iniciar Calibración Visual">Calibrar</button>
                    <button class="btn btn-outline-info btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#calibrationDetailsCollapse" title="Opciones de Escala">Escala</button>
                </div>
                <span id="current-scale-info" class="small ms-1" aria-live="polite">No Cal.</span>
            </div>
            
            <div class="col-auto"><div class="vr mx-1"></div></div>

            <div class="col-auto">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-primary btn-sm" id="measure-distance-btn" title="Medir Distancia">Distancia</button>
                    <button type="button" class="btn btn-primary btn-sm" id="measure-area-btn" title="Medir Área">Área</button>
                    <button type="button" class="btn btn-success btn-sm" id="finish-shape-btn" style="display:none;" title="Finalizar Forma">OK</button>
                </div>
            </div>

            <div class="col-auto"><div class="vr mx-1"></div></div>

            <div class="col-auto">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-secondary btn-sm" id="zoom-out-btn" title="Alejar">-</button>
                    <button type="button" class="btn btn-secondary btn-sm" id="zoom-in-btn" title="Acercar">+</button>
                </div>
                <span id="zoom-level-info" class="small ms-1" aria-live="polite">--%</span>
            </div>
             
            <div class="col-auto"><div class="vr mx-1"></div></div>

            {# NUEVO BLOQUE DE PAGINACIÓN #}
            <div class="col-auto">
                 <div class="input-group input-group-sm">
                     <button class="btn btn-outline-secondary" type="button" id="prev-page-btn" title="Página Anterior">‹</button>
                     <span class="input-group-text">
                          <span id="page-num" aria-live="polite">0</span>
                          <span class="mx-1">/</span>
                          <span id="page-count" aria-live="polite">0</span>
                     </span>
                     <button class="btn btn-outline-secondary" type="button" id="next-page-btn" title="Página Siguiente">›</button>
                     <input type="number" class="form-control" id="go-to-page-input" placeholder="Ir a pág." min="1" style="width: 90px;">
                     <button class="btn btn-secondary" type="button" id="go-to-page-btn">Ir</button>
                 </div>
            </div>
        <div class="collapse mt-2 p-2 border rounded bg-light" id="calibrationDetailsCollapse">
            </div>
    </div>
</div>

<div class="pdf-tool-layout-container">
    <main class="pdf-viewer-area">
        <div class="canvas-wrapper">
            <canvas id="pdf-canvas"></canvas>
            <canvas id="measure-canvas"></canvas>
        </div>
    </main>

    <aside class="controls-sidebar-reduced">
        <div class="measurements-log card h-100">
            <div class="card-body d-flex flex-column">
                <h3 class="card-title h6">Registro de Mediciones</h3>
                <ul id="measurements-list" class="list-group list-group-flush mb-2" style="flex-grow: 1; overflow-y: auto;">
                    {# Las mediciones se llenarán con JS #}
                </ul>
                <button type="button" class="btn btn-danger btn-sm w-100 mt-auto" id="clear-measurements-btn">Limpiar</button>
            </div>
        </div>
    </aside>
</div>
{% endblock %}


{# ================================================================== #}
{# BLOQUE 3: SCRIPTS ESPECÍFICOS DE LA PÁGINA                       #}
{# ================================================================== #}
{% block scripts %}
{{ super() }} {# Hereda los scripts de base.html (como el de Bootstrap) #}
<script>
    // Pasamos las variables de Flask a JavaScript de forma segura
    const PDF_URL_TO_LOAD = "{{ pdf_url_to_load | safe if pdf_url_to_load else '' }}";
    const PDF_WORKER_URL = "{{ pdf_worker_url | safe }}";
</script>
<script type="module" src="{{ url_for('static', filename='measure_tool/js/script.js') }}"></script>
{% endblock %}